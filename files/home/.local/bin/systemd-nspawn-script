#!/usr/bin/env bash

# Execute an ad hoc script in a systemd-nspawn container.
# Usage: systemd-nspawn-script DIRECTORY SCRIPT [ARGUMENT...]

set -euo pipefail

((EUID == 0)) || exec sudo -- "$0" "$@"

if [[ ! -v 1 ]]; then
    printf "The first argument must be a directory\n" >&2
    exit 1
fi

if [[ ! -d $1 || ! -r $1 ]]; then
    printf "Directory does not exist or is not readable: %q\n" "$1" >&2
    exit 1
fi

dir=$1

if [[ ! -v 2 ]]; then
    printf "The second argument must be a script file\n" >&2
    exit 1
fi

if [[ ! -f $2 || ! -r $2 ]]; then
    printf "File does not exist or is not readable: %q\n" "$2" >&2
    exit 1
fi

if ! head -n1 "$2" | grep -q '^#!'; then
    printf "Script has no shebang line: %q\n" "$2" >&2
    exit 1
fi

script=$2

shift 2

temp_script=$(mktemp -p "$dir" -t script.XXXXXXXXXX)
printf -v cleanup "rm -v %q" "$temp_script"
trap '$cleanup' EXIT

cp -v "$script" "$temp_script"
chmod -v +x "$temp_script"

systemd-nspawn --directory="$dir" /"${temp_script##*/}" "$@"
