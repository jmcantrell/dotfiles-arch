#!/usr/bin/env bash

# Configure this system as a VirtualBox host.

set -euo pipefail

sudo pacman --sync --noconfirm --needed virtualbox virtualbox-host-modules-arch

directory=${XDG_DATA_HOME:-$HOME/.local/share}/virtualbox

mkdir -p "$directory"

# Use this non-standard virtual machine location by default.
vboxmanage setproperty machinefolder "$directory"

# Disable copy-on-write if on a btrfs file system.
if [[ $(stat --file-system --format %T "$directory") == btrfs ]]; then
    chattr +C "$directory"
fi

# Load kernel modules for this boot.
xargs -I{} sudo modprobe {} </usr/lib/modules-load.d/virtualbox-host-modules-arch.conf

# Allow this user to manage VMs.
sudo gpasswd --add "$USER" vboxusers
