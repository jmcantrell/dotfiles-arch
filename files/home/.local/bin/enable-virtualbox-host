#!/usr/bin/env bash

# Configure this system as a VirtualBox host.

set -eu

sudo pacman --sync --noconfirm --needed virtualbox virtualbox-host-modules-arch
xargs -I{} sudo modprobe {} </usr/lib/modules-load.d/virtualbox-host-modules-arch.conf
sudo gpasswd --add "$USER" vboxusers

directory=${XDG_DATA_HOME:-$HOME/.local/share}/virtualbox

mkdir -p "$directory"

# Use this non-standard virtual machine location by default.
vboxmanage setproperty machinefolder "$directory"

# Disable copy-on-write if on a btrfs file system.
if [[ $(stat --file-system --format %T "$directory") == btrfs ]]; then
    chattr +C "$directory"
fi
