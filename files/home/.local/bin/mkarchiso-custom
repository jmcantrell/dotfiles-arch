#!/usr/bin/env bash

set -eu

output_dir=$PWD

temp_dir=$(mktemp -d -t "${0##*/}.XXXXXXXXXX")
printf -v cleanup "sudo rm -rf %q" "$temp_dir"
trap "$cleanup" INT TERM EXIT

build_dir=$temp_dir/build
profile_dir=$temp_dir/profile

cp -r /usr/share/archiso/configs/releng "$profile_dir"

cd -- "$profile_dir"

sed -i "/^DHCP=/a MulticastDNS=yes" ./airootfs/etc/systemd/network/*.network

declare -A file_permissions=()

if [[ -d /var/lib/iwd ]]; then
    file_permissions["/var/lib/iwd"]="0:0:700"
    mkdir -p ./airootfs/var/lib
    sudo cp -ra /var/lib/iwd ./airootfs/var/lib
fi

if [[ -f ~/.ssh/authorized_keys ]]; then
    file_permissions+=(
        ["/root/.ssh"]="0:0:700"
        ["/root/.ssh/authorized_keys"]="0:0:600"
    )
    mkdir -p ./airootfs/root/.ssh
    cp -a ~/.ssh/authorized_keys ./airootfs/root/.ssh
fi

for path in "${!file_permissions[@]}"; do
    sed -i "/^file_permissions=/a \ \ [\"$path\"]=\"${file_permissions[$path]}\"" ./profiledef.sh
done

sudo mkarchiso -v -w "$build_dir" -o "$output_dir" "$profile_dir"
