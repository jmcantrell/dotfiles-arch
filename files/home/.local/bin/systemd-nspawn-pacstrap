#!/usr/bin/env bash

# Initialize an Arch systemd-nspawn container.
# Usage: systemd-nspawn-pacstrap [PACKAGE...]

set -euo pipefail

(( EUID == 0 )) || exec sudo -- "$0" "$@"

if [[ ! -v 1 ]]; then
    printf "The first argument must be the container directory\n" >&2
    exit 1
fi

dir=$1

shift

mkdir -p "$dir"
pacstrap -c "$dir" base "$@"

systemd-nspawn -D "$dir" --console=pipe bash -s <<-EOF
set -euo pipefail

rm -f /{,usr/share/factory/}etc/securetty
sed -i '\:\s/etc/securetty$:s/^#*/#/' /usr/lib/tmpfiles.d/arch.conf

systemctl enable systemd-{networkd,resolved}.service

chpasswd <<<"root:hunter2"

ln -vsnf /usr/share/zoneinfo/UTC /etc/localtime
EOF
