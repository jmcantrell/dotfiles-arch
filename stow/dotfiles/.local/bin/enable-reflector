#!/usr/bin/env sh

# Enable periodic mirrorlist updates sorted by speed.

set -e

sudo pacman -S --noconfirm --needed reflector

# create update script

update=/usr/local/sbin/update-mirrorlist

sudo mkdir -p `dirname "$update"`

echo -e "#!/usr/bin/env sh\n
mirrorlist=/etc/pacman.d/mirrorlist
reflector --country US --age 12 --protocol https --sort rate --save \$mirrorlist
rm -f \$mirrorlist.pacnew
" | sudo tee "$update"

sudo chmod +x "$update"

# create hook to update on mirrorlist changes

hook=/etc/pacman.d/hooks/update-mirrorlist.hook

sudo mkdir -p "`dirname "$hook"`"

echo "[Trigger]
Operation=Upgrade
Type=Package
Target=pacman-mirrorlist

[Action]
Description=Updating pacman-mirrorlist with reflector
When=PostTransaction
Depends=reflector
Exec=$update
" | sudo tee "$hook"

# create service to run update

service=/etc/systemd/system/reflector.service

echo "[Unit]
Description=Pacman mirrorlist update

[Service]
Type=oneshot
ExecStart=$update
" | sudo tee "$service"

# create timer to run service periodically

timer=/etc/systemd/system/reflector.timer

echo "[Unit]
Description=Run reflector weekly

[Timer]
OnCalendar=weekly
RandomizedDelaySec=12h
Persistent=true

[Install]
WantedBy=timers.target
" | sudo tee "$timer"

sudo systemctl --now enable "`basename "$timer"`"
