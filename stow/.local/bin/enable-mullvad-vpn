#!/usr/bin/env bash

# Install and configure the Mullvad VPN app.

set -eu

# Ensure variables are available.
: \
    "$MULLVAD_ACCOUNT" \
    "$MULLVAD_COUNTRY" \
    "$MULLVAD_CITY"

curl -Ls https://mullvad.net/media/mullvad-code-signing.asc | gpg --import
pikaur --sync --noconfirm --needed mullvad-vpn-bin
sudo systemctl enable --now mullvad-daemon.service

mullvad account set "$MULLVAD_ACCOUNT"
mullvad auto-connect set on
mullvad lan set allow
mullvad relay set tunnel-protocol wireguard
mullvad relay set location "$MULLVAD_COUNTRY" "$MULLVAD_CITY"
mullvad tunnel ipv6 set on

if ! mullvad tunnel wireguard key check; then
    mullvad tunnel wireguard key regenerate
fi
