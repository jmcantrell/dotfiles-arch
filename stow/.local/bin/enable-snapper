#!/usr/bin/env bash

# Install and configure BTRFS subvolume snapshots with snapper.

set -eu

sudo pacman -S --noconfirm --needed snapper

readarray -t subvols < <(
    sudo btrfs subvolume list / |
        grep -w "top level 5" |
        awk '{print $NF}'
)

for subvol in "${subvols[@]}"; do
    name=${subvol#@}
    sudo snapper -c "${name:-root}" create-config "/$name" || continue
done

sudo systemctl enable --now snapper-{timeline,cleanup}.timer
