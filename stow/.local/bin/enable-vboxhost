#!/usr/bin/env bash

set -e

sudo pacman -Sy --noconfirm --needed virtualbox virtualbox-host-modules-arch
pikaur -Sy --noconfirm --needed virtualbox-ext-oracle
sudo gpasswd -a "$USER" vboxusers

vms_dir=${XDG_DATA_HOME:-$HOME/.local/share}/virtualbox
mkdir -p "$vms_dir"

vboxmanage setproperty machinefolder "$vms_dir"

# Disable btrfs copy-on-write for vms directory.
fstype=$(mount | grep " $(dirname "$HOME") " | cut -d' ' -f5)
[[ "$fstype" = btrfs ]] && chattr +C "$vms_dir"
