#!/usr/bin/env bash

# Install and configure the PostgreSQL database.

set -e

sudo pacman -Sy --noconfirm --needed postgresql

user=postgres
sudo chpasswd <<<"$user:$user"
echo "Database password for user '$user' set to '$user'" >&2

postgres=/var/lib/postgres
data=$postgres/data
config=$data/postgresql.conf

# Disable btrfs copy-on-write for database directory.
fstype=$(mount | grep " /var " | cut -d' ' -f5)
test "$fstype" = btrfs && sudo chattr +C "$postgres"

sudo -u postgres -i initdb --no-locale --encoding=utf-8 --pgdata="$data"

enable_line() {
    sudo sed -i "/^#\?$1\b/{ s/^#//; ${2:+s:=.*:= $2:;} }" "$config"
}

enable_line timezone utc
enable_line log_statement all
enable_line synchronous_commit off
enable_line stats_temp_directory "'/run/postgresql'"

sudo systemctl enable --now postgresql.service

# Create a superuser account for myself.
sudo -u postgres -i createuser -drs "$USER"
