#!/usr/bin/env bash

# Install and configure a PostgreSQL database.

set -eu

sudo pacman --sync --noconfirm --needed postgresql

data_dir=/var/lib/postgres/data

# Disable copy-on-write if on a btrfs file system.
if [[ $(stat -f -c %T /var) == btrfs ]]; then
    sudo chattr +C "$data_dir"
fi

sudo -u postgres -i initdb --no-locale --encoding=utf-8 --pgdata="$data_dir"

enable_line() {
    sudo sed -i "/^#\?$1\b/{ s/^#//; ${2:+s:=.*:= $2:;} }" "$data_dir"/postgresql.conf
}

enable_line timezone utc
enable_line log_statement all
enable_line synchronous_commit off
enable_line stats_temp_directory "'/run/postgresql'"

sudo systemctl enable --now postgresql.service

# Create a superuser account for myself.
sudo -u postgres -i createuser -drs "$USER"
