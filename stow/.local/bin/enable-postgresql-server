#!/usr/bin/env bash

# Install and configure postgresql database.

set -e

sudo pacman -Sy --noconfirm --needed postgresql

user=postgres
echo -e "$user\n$user" | sudo passwd "$user" &>/dev/null
echo "Database password for user '$user' set to '$user'" >&2

postgres=/var/lib/postgres
data=$postgres/data
config=$data/postgresql.conf

# Disable btrfs copy-on-write for database directory.
fstype=$(mount | grep " /var " | cut -d' ' -f5)
test "$fstype" = btrfs && sudo chattr +C "$postgres"

sudo -u postgres -i initdb --locale "$LANG" -E UTF8 -D "$data"

enable_line() {
    sudo sed -i "/^#\?$1\b/{ s/^#//; ${2:+s:=.*:= $2:;} }" "$config"
}

# Store stats in memory instead of disk.
enable_line stats_temp_directory "'/run/postgresql'"

# Speed up commits.
enable_line synchronous_commit off

sudo systemctl enable --now postgresql.service

sudo -u postgres -i createuser -drs "$USER"
