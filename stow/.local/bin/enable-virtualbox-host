#!/usr/bin/env bash

# Install and configure VirtualBox to be used as a virtual machine host.

set -eu

sudo pacman -S --noconfirm --needed virtualbox virtualbox-host-modules-arch
xargs -r -I{} sudo modprobe {} </usr/lib/modules-load.d/virtualbox-host-modules-arch.conf

sudo gpasswd -a "$USER" vboxusers

vms_dir=${XDG_DATA_HOME:-$HOME/.local/share}/virtualbox

mkdir -p "$vms_dir"

vboxmanage setproperty machinefolder "$vms_dir"

# Disable copy-on-write if on a btrfs file system.
if [[ $(stat -f -c %T "$vms_dir") == btrfs ]]; then
    chattr +C "$vms_dir"
fi
